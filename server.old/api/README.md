# Maxxit DeFi NestJS REST API

## Overview

Complete NestJS REST API for the Maxxit DeFi platform with JWT authentication, Swagger documentation, and comprehensive data validation.

## Running the API

```bash
# Start the NestJS API (runs on port 3000)
npm run dev:nest

# Or use tsx directly
tsx server/nest-main.ts
```

The API will be available at:
- **API Base URL**: `http://0.0.0.0:3000`
- **Swagger Documentation**: `http://0.0.0.0:3000/api-docs`

## Architecture

### Main Files
- **server/nest-main.ts**: Bootstrap NestJS application with Swagger
- **server/nest-app.module.ts**: Main app module importing all feature modules

### Modules

#### 1. Auth Module (`server/api/auth/`)
Authentication with Sign-In with Ethereum (SIWE) and JWT tokens.

**Endpoints:**
- `POST /api/auth/siwe` - Login with Ethereum signature
- `GET /api/auth/me` - Get current user wallet + deployments (protected)

**Files:**
- `auth.controller.ts` - Route handlers
- `auth.service.ts` - Business logic
- `auth.module.ts` - Module configuration
- `jwt.strategy.ts` - Passport JWT strategy
- `dto.ts` - DTOs with class-validator

#### 2. Agents Module (`server/api/agents/`)
Manage trading agents with performance metrics.

**Endpoints:**
- `GET /api/agents` - Paginated leaderboard with filters
- `GET /api/agents/:id` - Agent details + recent performance
- `POST /api/agents` - Create agent (protected)
- `PATCH /api/agents/:id` - Update agent status/weights (protected, owner only)

**Features:**
- Weights validation (8 elements, 0-100 each)
- Sorting by APR30d, APR90d, Sharpe30d
- Pagination (default 20, max 100)

#### 3. Deployments Module (`server/api/deployments/`)
Deploy agents to user Safe wallets.

**Endpoints:**
- `GET /api/deployments` - Get deployments with filters (protected)
- `POST /api/deployments` - Create deployment + install Safe module (protected)
- `PATCH /api/deployments/:id` - Pause/resume/cancel (protected, owner only)

**Features:**
- Automatic Safe module installation via RelayerService
- Trial period management
- Subscription billing integration

#### 4. Signals Module (`server/api/signals/`)
Trading signals generated by agents.

**Endpoints:**
- `GET /api/signals` - Query signals with filters (read-only)

**Filters:**
- agentId
- tokenSymbol
- from/to date range
- Pagination

#### 5. Positions Module (`server/api/positions/`)
Trading positions with PnL calculations.

**Endpoints:**
- `GET /api/positions` - Query positions with filters (read-only)

**Features:**
- Real-time PnL calculation for open positions
- Status filtering (OPEN/CLOSED)
- Deployment filtering

#### 6. Billing Module (`server/api/billing/`)
Billing events tracking.

**Endpoints:**
- `GET /api/billing` - Query billing events (read-only)

**Event Types:**
- SUBSCRIPTION - Monthly subscription fees
- INFRA_FEE - Per-trade infrastructure fees
- PROFIT_SHARE - Performance-based fees

#### 7. Admin Module (`server/api/admin/`)
Administrative operations (protected).

**Endpoints:**
- `POST /api/admin/refresh-venues` - Update VenueStatus + TokenRegistry
- `POST /api/admin/rebuild-metrics` - Recompute agent APR/Sharpe metrics

## Authentication

All protected routes require JWT Bearer token:

```bash
# 1. Login
curl -X POST http://localhost:3000/api/auth/siwe \
  -H "Content-Type: application/json" \
  -d '{
    "wallet": "0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb",
    "signature": "sig",
    "message": "msg"
  }'

# Returns: { "accessToken": "...", "wallet": "..." }

# 2. Use token in subsequent requests
curl http://localhost:3000/api/auth/me \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"
```

## Validation

All DTOs use class-validator decorators:
- `@IsString()`, `@IsUUID()`, `@IsEnum()`
- `@IsArray()`, `@ArrayMinSize()`, `@ArrayMaxSize()`
- `@IsInt()`, `@Min()`, `@Max()`
- `@IsOptional()` for optional fields
- `@Type()` for type transformation

## Error Handling

Standard HTTP exceptions:
- `400 Bad Request` - Validation errors
- `401 Unauthorized` - Missing/invalid JWT
- `403 Forbidden` - Insufficient permissions
- `404 Not Found` - Resource not found
- `500 Internal Server Error` - Server errors

## Pagination

Standard pagination response:
```json
{
  "data": [...],
  "total": 100,
  "page": 1,
  "limit": 20
}
```

Query parameters:
- `limit` (default: 20, max: 100)
- `page` (default: 1)

## Example Requests

### Create an Agent
```bash
curl -X POST http://localhost:3000/api/agents \
  -H "Authorization: Bearer YOUR_JWT" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Alpha Trader",
    "venue": "GMX",
    "weights": [10, 20, 15, 25, 10, 5, 10, 5]
  }'
```

### Deploy an Agent
```bash
curl -X POST http://localhost:3000/api/deployments \
  -H "Authorization: Bearer YOUR_JWT" \
  -H "Content-Type: application/json" \
  -d '{
    "agentId": "uuid-of-agent",
    "safeWallet": "0x..."
  }'
```

### Query Agents Leaderboard
```bash
curl "http://localhost:3000/api/agents?venue=GMX&status=ACTIVE&sort=apr30d&limit=10&page=1"
```

## Dependencies

Key NestJS packages:
- `@nestjs/common`, `@nestjs/core` - Framework
- `@nestjs/platform-express` - Express adapter
- `@nestjs/swagger` - OpenAPI documentation
- `@nestjs/jwt`, `@nestjs/passport` - Authentication
- `@prisma/client` - Database ORM
- `class-validator`, `class-transformer` - Validation
- `passport-jwt` - JWT strategy

## Database

Uses Prisma with PostgreSQL. All services inject `PrismaService` for database access.

Schema defined in `prisma/schema.prisma`.

## Configuration

Environment variables (in `server/config/config.ts`):
- `DATABASE_URL` - PostgreSQL connection string
- `JWT_SECRET` - JWT signing secret
- `RELAYER_URL` - Safe relayer service URL
- `SAFE_MODULE_ADDR` - Safe module contract address
